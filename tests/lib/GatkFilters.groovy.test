nextflow_function {

    name "Test GatkFilters.groovy"

    test("Test parse Map - valid entries") {
        function "GatkFilters.parse"

        when {
            function {
                """
                input[0] = [
                    QD_filter: "QD < 2.0",
                    FS_filter: "FS > 60.0"
                ]
                """
            }
        }

        then {
            assert function.success

            def result = function.result

            assert result.size() == 2
            assert result["QD_filter"] == "QD < 2.0"
            assert result["FS_filter"] == "FS > 60.0"
        }

    }

    test("Test parse Map - invalid entries are ignored") {
        function "GatkFilters.parse"

        when {
            function {
                """
                input[0] = [
                    OK: "A>1",
                    MISSING_EXPR: "",
                    "": "NO_NAME"
                ]
                """
            }
        }

        then {
            assert function.success

            def result = function.result

            assert result.size() == 1
            assert result["OK"] == "A>1"
          }

    }

    test("Test parse string - pipe separated") {
        function "GatkFilters.parse"

        when {
            function {
                """
                input[0] = "QD_filter:QD<2.0|FS_filter:FS>60.0|SOR_filter:SOR>3.0"
                """
            }
        }

        then {
            assert function.success

            def result = function.result

            assert result.size() == 3
            assert result["QD_filter"]  == "QD<2.0"
            assert result["FS_filter"]  == "FS>60.0"
            assert result["SOR_filter"] == "SOR>3.0"
        }

    }

    test("Test parse string - do not split double pipe") {
        function "GatkFilters.parse"

        when {
            function {
                """
                input[0] = "weird:DP>10||QUAL>30|normal:QD<2.0"
                """
            }
        }

        then {
            assert function.success

            def result = function.result

            assert result.size() == 2
            assert result["weird"]  == "DP>10||QUAL>30"
            assert result["normal"] == "QD<2.0"
        }

    }

    test("Test parse empty string returns empty Map") {
        function "GatkFilters.parse"

        when {
            function {
                """
                input[0] = " "
                """
            }
        }

        then {
            assert function.success

            def result = function.result

            assert result instanceof Map
            assert result.size() == 0
        }

    }

    test("Test parse null returns empty Map") {
        function "GatkFilters.parse"

        when {
            function {
                """
                input[0] = null
                """
            }
        }

        then {
            assert function.success

            def result = function.result

            assert result instanceof Map
            assert result.size() == 0
        }

    }

}
